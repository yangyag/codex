version: "3.9"

services:
  postgres:
    image: postgres:15
    container_name: msa-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-msa}
      POSTGRES_USER: ${POSTGRES_USER:-msa}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-msa-password}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-msa} -d ${POSTGRES_DB:-msa}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - msa-net

  identity-service:
    build:
      context: ../services/identity-service
    container_name: identity-service
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: msa
      DB_USERNAME: msa
      DB_PASSWORD: msa-password
      SERVER_PORT: ${IDENTITY_PORT:-8081}
      MEMBER_SERVICE_URL: http://member-service:${MEMBER_PORT:-8082}
    ports:
      - "${IDENTITY_PORT:-8081}:${IDENTITY_PORT:-8081}"
    networks:
      - msa-net

  api-gateway:
    build:
      context: ../gateway/api-gateway
    container_name: api-gateway
    depends_on:
      identity-service:
        condition: service_started
      member-service:
        condition: service_started
    environment:
      SERVER_PORT: ${GATEWAY_SERVER_PORT:-8080}
      IDENTITY_SERVICE_URL: http://identity-service:${IDENTITY_PORT:-8081}
      MEMBER_SERVICE_URL: http://member-service:${MEMBER_PORT:-8082}
      JWT_SECRET: ${JWT_SECRET:-change-me-please-change-me-32bytes}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:8080,http://127.0.0.1:8080}
    ports:
      - "${GATEWAY_PORT:-8083}:${GATEWAY_SERVER_PORT:-8080}"
    networks:
      - msa-net

  admin-web:
    build:
      context: ../apps/admin-web
    container_name: admin-web
    depends_on:
      - identity-service
      - member-service
      - api-gateway
    environment:
      - VITE_API_BASE=http://127.0.0.1:${GATEWAY_PORT:-8083}
      - VITE_MEMBER_API_BASE=http://127.0.0.1:${GATEWAY_PORT:-8083}
    ports:
      - "8080:8080"
    networks:
      - msa-net

  member-service:
    build:
      context: ../services/member-service
    container_name: member-service
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: msa
      DB_USERNAME: msa
      DB_PASSWORD: msa-password
      SERVER_PORT: ${MEMBER_PORT:-8082}
      JWT_SECRET: ${JWT_SECRET:-change-me-please-change-me-32bytes}
    ports:
      - "${MEMBER_PORT:-8082}:${MEMBER_PORT:-8082}"
    networks:
      - msa-net

networks:
  msa-net:
    driver: bridge

volumes:
  postgres_data:
